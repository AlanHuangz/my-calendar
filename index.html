<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ•™å‹™ç®¡ç†è¡Œäº‹æ›† v3.0</title>
<style>
  :root {
    --col-sun: #f8f9fa;
    --col-14: #e3f2fd; 
    --col-25: #e8f5e9; 
    --col-36: #fff3e0; 
  }
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #eceff1; margin: 0; display: flex; height: 100vh; overflow: hidden; }
  
  #calendar-container { flex: 7; padding: 20px; display: flex; flex-direction: column; min-width: 0; }
  .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: white; padding: 10px 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
  button { padding: 8px 16px; background-color: #475569; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
  button:hover { background-color: #334155; }
  .btn-exam { background-color: #ef4444; font-weight: bold; margin-top: 10px;}
  .btn-exam:hover { background-color: #dc2626; }
  
  .weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-weight: bold; color: #475569; margin-bottom: 5px; font-size: 14px; }
  .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); grid-auto-rows: minmax(0, 1fr); gap: 4px; flex: 1; }
  
  .day-cell { 
    background: white; border-radius: 6px; padding: 6px; cursor: pointer; 
    display: flex; flex-direction: column; box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
    border: 2px solid transparent; transition: 0.2s;
    /* è™•ç†è³‡è¨Šçˆ†ç‚¸çš„é—œéµï¼šå…§éƒ¨æ²å‹• */
    overflow-y: auto; overflow-x: hidden;
  }
  /* ç¾åŒ–æ²å‹•è»¸ */
  .day-cell::-webkit-scrollbar { width: 4px; }
  .day-cell::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
  
  .day-cell.active { border-color: #3b82f6; }
  .day-cell:hover { filter: brightness(0.95); }
  
  .day-cell:nth-child(7n+1) { background-color: var(--col-sun); }
  .day-cell:nth-child(7n+2), .day-cell:nth-child(7n+5) { background-color: var(--col-14); }
  .day-cell:nth-child(7n+3), .day-cell:nth-child(7n+6) { background-color: var(--col-25); }
  .day-cell:nth-child(7n+4), .day-cell:nth-child(7n+7) { background-color: var(--col-36); }

  .date-num { font-weight: bold; margin-bottom: 4px; color: #1e293b; font-size: 13px; position: sticky; top: 0; background: inherit; z-index: 2;}
  
  /* å¾®å‹æ¨™ç±¤è¨­è¨ˆ */
  .event-badge {
    color: white; padding: 2px 4px; border-radius: 3px; font-size: 11px; margin-bottom: 3px; 
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2;
  }
  .event-countdown { border: 1px solid #ef4444; color: #ef4444; background: transparent; font-weight: bold; }
  .event-prep { background-color: #8b5cf6; }

  #panel-container { flex: 3; background: white; border-left: 1px solid #cbd5e1; padding: 20px; display: flex; flex-direction: column; overflow-y: auto; min-width: 300px;}
  .panel-header { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #0f172a; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px;}
  
  .event-list-item { display: flex; align-items: center; background: #f8f9fa; padding: 8px; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid #cbd5e1; }
  .event-list-item input[type="checkbox"] { transform: scale(1.2); margin-right: 10px; cursor: pointer;}
  .event-list-title { flex: 1; font-size: 13px; }
  .event-del-btn { background: #ef4444; padding: 4px 8px; font-size: 11px; margin-left: 10px;}
  
  .add-section { margin-top: 15px; background: #f1f5f9; padding: 12px; border-radius: 8px; }
  .add-section h4 { margin: 0 0 10px 0; color: #334155; font-size: 14px;}
  .form-group { margin-bottom: 10px; }
  .form-group label { font-size: 12px; color: #475569; display: block; margin-bottom: 4px;}
  .form-group input[type="text"], .form-group select { width: 100%; padding: 6px; box-sizing: border-box; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 13px;}
</style>
</head>
<body>

<div id="calendar-container">
  <div class="header">
    <button onclick="changeWeek(-1)">â—„ ä¸Šä¸€é€±</button>
    <h2 id="viewRangeDisplay" style="margin:0; color:#1e293b; font-size: 18px;">è¼‰å…¥ä¸­...</h2>
    <button onclick="changeWeek(1)">ä¸‹ä¸€é€± â–º</button>
  </div>
  <div class="weekdays">
    <div>æ—¥</div><div>ä¸€ (1/4ç­)</div><div>äºŒ (2/5ç­)</div><div>ä¸‰ (3/6ç­)</div><div>å›› (1/4ç­)</div><div>äº” (2/5ç­)</div><div>å…­ (3/6ç­)</div>
  </div>
  <div class="days-grid" id="daysGrid"></div>
</div>

<div id="panel-container">
  <div class="panel-header" id="panelTitle">è«‹é¸æ“‡æ—¥æœŸ</div>
  <div id="eventList"></div>
  
  <div class="add-section" id="normalAddSection" style="display:none;">
    <h4>â• æ–°å¢ä»£è¾¦ / è¨˜äº‹</h4>
    <div class="form-group"><input type="text" id="evTitle" placeholder="è¼¸å…¥äº‹é …åç¨±..."></div>
    <div class="form-group" style="display:flex; gap:10px; align-items:center;">
      <select id="evColor" style="flex:1;">
        <option value="#3b82f6">è—è‰² (ä¸€èˆ¬)</option><option value="#10b981">ç¶ è‰² (å®Œæˆ)</option>
        <option value="#f59e0b">é»ƒè‰² (æ³¨æ„)</option><option value="#64748b">ç°è‰² (å‚™è¨»)</option>
      </select>
      <label style="margin:0;"><input type="checkbox" id="evShow" checked> é¡¯ç¤ºåœ¨æœˆæ›†</label>
    </div>
    <button onclick="addNormalEvent()" style="width:100%;">æ–°å¢äº‹é …</button>
  </div>

  <div class="add-section" id="examAddSection" style="display:none; background:#fee2e2; border:1px solid #fca5a5;">
    <h4>â­ å»ºç«‹æ®µè€ƒæ’ç¨‹ (é›™é€±åŠ å¼·)</h4>
    <div class="form-group">
      <label>ç›®æ¨™ç­ç´š (ç³»çµ±è‡ªå‹•åˆ¤æ–·å¹´ç´š)</label>
      <select id="examClass">
        <option value="14">ä¸€å››ç­</option>
        <option value="25">äºŒäº”ç­</option>
        <option value="36">ä¸‰å…­ç­</option>
      </select>
    </div>
    <div class="form-group">
      <label>é€£å‡è¿´é¿è¨­å®š</label>
      <select id="skipHoliday">
        <option value="none">æ­£å¸¸ (è€ƒå‰ç¬¬ä¸€ã€ç¬¬äºŒå€‹é€±å…­)</option>
        <option value="sat1">è·³éè€ƒå‰ç¬¬ä¸€é€± (å»¶è‡³ç¬¬ä¸‰é€±)</option>
        <option value="sat2">è·³éè€ƒå‰ç¬¬äºŒé€± (å»¶è‡³ç¬¬ä¸‰é€±)</option>
      </select>
    </div>
    <button class="btn-exam" onclick="generateExamSchedule()" style="width:100%;">è‡ªå‹•ç”Ÿæˆ 2å ‚åŠ å¼·èª² èˆ‡ å€’æ•¸</button>
  </div>
</div>

<script>
  let db = JSON.parse(localStorage.getItem('crm_events_v3')) || [];
  let currentStartSunday = getSunday(new Date());
  let selectedDateStr = null;

  function getSunday(d) { let dt = new Date(d); dt.setDate(dt.getDate() - dt.getDay()); return dt; }
  function formatDate(d) { return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`; }

  // æ ¸å¿ƒå¤§è…¦ï¼šå¹´ç´šè‡ªå‹•åˆ¤æ–·å¼•æ“
  function getDynamicGrade(classType, targetDateObj) {
    let year = targetDateObj.getFullYear();
    let month = targetDateObj.getMonth() + 1;
    // æ¯å¹´ 8 æœˆ 1 æ—¥ä½œç‚ºå­¸å¹´åˆ‡æ›é»
    let academicYear = month < 8 ? year - 1 : year; 
    let offset = academicYear - 2025; // ä»¥ 2025 å­¸å¹´ç‚ºåŸºæº–
    
    let baseGrade;
    if(classType === '14') baseGrade = 7; // 2025æ™‚ 14æ˜¯åœ‹ä¸€(7)
    else if(classType === '25') baseGrade = 9; // 2025æ™‚ 25æ˜¯åœ‹ä¸‰(9)
    else if(classType === '36') baseGrade = 8; // 2025æ™‚ 36æ˜¯åœ‹äºŒ(8)
    
    // è¨ˆç®—å¹´ç´šå¾ªç’° (7->8->9->7)
    let currentGrade = (((baseGrade - 7 + offset) % 3) + 3) % 3 + 7;
    
    if(currentGrade === 7) return "åœ‹ä¸€";
    if(currentGrade === 8) return "åœ‹äºŒ";
    if(currentGrade === 9) return "åœ‹ä¸‰";
  }

  function renderCalendar() {
    const grid = document.getElementById('daysGrid');
    grid.innerHTML = '';
    let endDate = new Date(currentStartSunday); endDate.setDate(endDate.getDate() + 27); 
    document.getElementById('viewRangeDisplay').innerText = `${currentStartSunday.getMonth()+1}/${currentStartSunday.getDate()} - ${endDate.getMonth()+1}/${endDate.getDate()}`;

    for (let i = 0; i < 28; i++) {
      let d = new Date(currentStartSunday); d.setDate(d.getDate() + i);
      let dStr = formatDate(d);
      
      let cell = document.createElement('div');
      cell.className = `day-cell ${dStr === selectedDateStr ? 'active' : ''}`;
      cell.onclick = () => selectDate(dStr);
      
      let numDiv = document.createElement('div');
      numDiv.className = 'date-num';
      numDiv.innerText = d.getDate() === 1 ? `${d.getMonth()+1}æœˆ1æ—¥` : d.getDate();
      cell.appendChild(numDiv);

      let dayEvents = db.filter(e => e.date === dStr && e.show);
      dayEvents.forEach(e => {
        let badge = document.createElement('div');
        badge.className = 'event-badge';
        if(e.type === 'countdown') badge.classList.add('event-countdown');
        else if(e.type === 'prep') badge.classList.add('event-prep');
        else badge.style.backgroundColor = e.color;
        
        badge.innerText = e.title;
        cell.appendChild(badge);
      });
      grid.appendChild(cell);
    }
  }

  function selectDate(dStr) {
    selectedDateStr = dStr;
    document.getElementById('panelTitle').innerText = `ğŸ“ ${dStr}`;
    document.getElementById('normalAddSection').style.display = 'block';
    document.getElementById('examAddSection').style.display = 'block';
    renderPanel(); renderCalendar();
  }

  function renderPanel() {
    const list = document.getElementById('eventList');
    list.innerHTML = '';
    if(!selectedDateStr) return;

    let dayEvents = db.filter(e => e.date === selectedDateStr);
    if(dayEvents.length === 0) { list.innerHTML = '<p style="color:#94a3b8; font-size:13px;">ç•¶æ—¥ç„¡äº‹é …</p>'; return; }

    dayEvents.forEach(e => {
      let item = document.createElement('div');
      item.className = 'event-list-item';
      item.style.borderLeftColor = e.color || '#ef4444';
      
      item.innerHTML = `
        <input type="checkbox" title="é¡¯ç¤ºåœ¨æœˆæ›†ä¸Š" ${e.show ? 'checked' : ''} onchange="toggleShow('${e.id}')">
        <div class="event-list-title" style="${e.type==='countdown'?'color:#ef4444;font-weight:bold;':''}">${e.title}</div>
        <button class="event-del-btn" onclick="deleteEvent('${e.id}')">åˆª</button>
      `;
      list.appendChild(item);
    });
  }

  function changeWeek(offset) { currentStartSunday.setDate(currentStartSunday.getDate() + (offset * 7)); renderCalendar(); }

  function addNormalEvent() {
    let title = document.getElementById('evTitle').value;
    if(!title) return;
    db.push({ id: Date.now().toString(), date: selectedDateStr, title: title, show: document.getElementById('evShow').checked, color: document.getElementById('evColor').value, type: 'normal' });
    document.getElementById('evTitle').value = '';
    saveAndRender();
  }

  function toggleShow(id) { let ev = db.find(e => e.id === id); if(ev) ev.show = !ev.show; saveAndRender(); }
  function deleteEvent(id) { db = db.filter(e => e.id !== id); saveAndRender(); }
  function saveAndRender() { localStorage.setItem('crm_events_v3', JSON.stringify(db)); renderPanel(); renderCalendar(); }

  // æ ¸å¿ƒå¤§è…¦ï¼šé›™é€±åŠ å¼·èˆ‡é€£å‡è¿´é¿é‚è¼¯
  function generateExamSchedule() {
    if(!selectedDateStr) return;
    
    let classType = document.getElementById('examClass').value;
    let skipAction = document.getElementById('skipHoliday').value;
    let examDate = new Date(selectedDateStr);
    
    // è‡ªå‹•å–å¾—æ­£ç¢ºçš„å¹´ç´šï¼
    let gradeName = getDynamicGrade(classType, examDate);
    
    // 1. å»ºç«‹æ®µè€ƒæ—¥
    db.push({ id: Date.now().toString() + "_ex", date: selectedDateStr, title: `ğŸ† ${gradeName} æ®µè€ƒ`, show: true, color: '#ef4444', type: 'exam' });

    // 2. å°‹æ‰¾è€ƒå‰é€±å…­ (ç²¾æº–å®šä½)
    let dayOfWeek = examDate.getDay();
    let sat1 = new Date(examDate);
    // æ‰¾æœ€è¿‘çš„é€±å…­ã€‚å¦‚æœæ®µè€ƒå‰›å¥½åœ¨é€±å…­(6)ï¼Œå‰ä¸€å€‹é€±å…­å°±æ˜¯7å¤©å‰ã€‚
    let daysToSat1 = dayOfWeek === 6 ? 7 : dayOfWeek + 1;
    sat1.setDate(sat1.getDate() - daysToSat1);
    
    let sat2 = new Date(sat1); sat2.setDate(sat2.getDate() - 7);
    let sat3 = new Date(sat1); sat3.setDate(sat3.getDate() - 14);

    let prepDays = [];
    if(skipAction === 'none') { prepDays = [sat1, sat2]; }
    else if(skipAction === 'sat1') { prepDays = [sat2, sat3]; } // è·³éç¬¬ä¸€é€±
    else if(skipAction === 'sat2') { prepDays = [sat1, sat3]; } // è·³éç¬¬äºŒé€±

    // ç”Ÿæˆå…©æ¬¡åŠ å¼·èª²
    prepDays.forEach((pDate, idx) => {
      db.push({ id: Date.now().toString() + "_p" + idx, date: formatDate(pDate), title: `ğŸ›¡ï¸ ${gradeName} åŠ å¼·`, show: true, type: 'prep' });
    });

    // 3. ç”Ÿæˆå€’æ•¸ (è€ƒå‰å…©é€±å…§)
    let countdownStart = new Date(sat1); 
    countdownStart.setDate(countdownStart.getDate() - 13); // å¾ sat1 çš„å‰ä¸€é€±æ—¥é–‹å§‹ç®—ï¼ŒåŒ…è¾¦å…©é€±

    let classDaysMatch = classType === '14' ? [1, 4] : classType === '25' ? [2, 5] : [3, 6];
    let classDates = [];
    
    for(let d = new Date(countdownStart); d < examDate; d.setDate(d.getDate() + 1)) {
      if(classDaysMatch.includes(d.getDay())) classDates.push(formatDate(d));
    }

    let total = classDates.length;
    classDates.forEach((dStr, index) => {
      db.push({ id: Date.now().toString() + "_c" + index, date: dStr, title: `ğŸ”¥${gradeName}å€’æ•¸: ${total - index}`, show: true, type: 'countdown' });
    });

    alert(`å·²å»ºç«‹ï¼\nå°è±¡ï¼š${gradeName}\nåŠ å¼·æ—¥ï¼š${formatDate(prepDays[0])} & ${formatDate(prepDays[1])}`);
    saveAndRender();
  }

  renderCalendar();
</script>

</body>
</html>
