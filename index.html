<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ•™å‹™ç®¡ç†è¡Œäº‹æ›†</title>
<style>
  :root {
    --col-sun: #f8f9fa;
    --col-14: #e3f2fd; /* ä¸€å››è— */
    --col-25: #e8f5e9; /* äºŒäº”ç¶  */
    --col-36: #fff3e0; /* ä¸‰å…­æ©˜ */
  }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #eceff1;
    margin: 0;
    display: flex;
    height: 100vh;
    overflow: hidden;
  }
  /* å·¦å´è¡Œäº‹æ›†å€å¡Š */
  #calendar-container {
    flex: 7;
    padding: 20px;
    display: flex;
    flex-direction: column;
  }
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    background: white;
    padding: 10px 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  button {
    padding: 8px 16px;
    background-color: #475569;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
  }
  button:hover { background-color: #334155; }
  .btn-exam { background-color: #ef4444; font-weight: bold; }
  .btn-exam:hover { background-color: #dc2626; }
  
  .weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    text-align: center;
    font-weight: bold;
    color: #475569;
    margin-bottom: 5px;
  }
  .days-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    grid-auto-rows: minmax(120px, 1fr);
    gap: 4px;
    flex: 1;
  }
  .day-cell {
    background: white;
    border-radius: 6px;
    padding: 8px;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    border: 2px solid transparent;
    transition: 0.2s;
  }
  .day-cell.active { border-color: #3b82f6; }
  .day-cell:hover { filter: brightness(0.95); }
  
  /* ç›´è¡ŒèƒŒæ™¯è‰²è¨­å®š (nth-child æ˜¯ 1-indexed, 1=æ—¥) */
  .day-cell:nth-child(7n+1) { background-color: var(--col-sun); }
  .day-cell:nth-child(7n+2), .day-cell:nth-child(7n+5) { background-color: var(--col-14); }
  .day-cell:nth-child(7n+3), .day-cell:nth-child(7n+6) { background-color: var(--col-25); }
  .day-cell:nth-child(7n+4), .day-cell:nth-child(7n+7) { background-color: var(--col-36); }

  .date-num { font-weight: bold; margin-bottom: 5px; color: #1e293b; }
  
  .event-badge {
    color: white;
    padding: 3px 6px;
    border-radius: 4px;
    font-size: 12px;
    margin-bottom: 3px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .event-countdown { border: 2px solid #ef4444; color: #ef4444; background: white; font-weight: bold; }

  /* å³å´æ§åˆ¶é¢æ¿ */
  #panel-container {
    flex: 3;
    background: white;
    border-left: 1px solid #cbd5e1;
    padding: 20px;
    box-shadow: -2px 0 10px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: column;
    overflow-y: auto;
  }
  .panel-header { font-size: 20px; font-weight: bold; margin-bottom: 20px; color: #0f172a; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px;}
  
  .event-list-item {
    display: flex;
    align-items: center;
    background: #f8f9fa;
    padding: 10px;
    border-radius: 6px;
    margin-bottom: 10px;
    border-left: 4px solid #cbd5e1;
  }
  .event-list-item input[type="checkbox"] { transform: scale(1.3); margin-right: 12px; cursor: pointer;}
  .event-list-title { flex: 1; font-size: 14px; }
  .event-del-btn { background: #ef4444; padding: 4px 8px; font-size: 12px; margin-left: 10px;}
  
  .add-section { margin-top: 20px; background: #f1f5f9; padding: 15px; border-radius: 8px; }
  .add-section h4 { margin: 0 0 10px 0; color: #334155; }
  .form-group { margin-bottom: 10px; }
  .form-group label { font-size: 13px; color: #475569; display: block; margin-bottom: 4px;}
  .form-group input[type="text"], .form-group select { width: 100%; padding: 6px; box-sizing: border-box; border: 1px solid #cbd5e1; border-radius: 4px;}
</style>
</head>
<body>

<div id="calendar-container">
  <div class="header">
    <button onclick="changeWeek(-1)">â—„ ä¸Šä¸€é€±</button>
    <h2 id="viewRangeDisplay" style="margin:0; color:#1e293b;">è¼‰å…¥ä¸­...</h2>
    <button onclick="changeWeek(1)">ä¸‹ä¸€é€± â–º</button>
  </div>
  <div class="weekdays">
    <div>æ—¥</div><div>ä¸€ (1/4)</div><div>äºŒ (2/5)</div><div>ä¸‰ (3/6)</div><div>å›› (1/4)</div><div>äº” (2/5)</div><div>å…­ (3/6)</div>
  </div>
  <div class="days-grid" id="daysGrid"></div>
</div>

<div id="panel-container">
  <div class="panel-header" id="panelTitle">è«‹é¸æ“‡æ—¥æœŸ</div>
  <div id="eventList"></div>
  
  <div class="add-section" id="normalAddSection" style="display:none;">
    <h4>â• æ–°å¢ä»£è¾¦ / è¨˜äº‹</h4>
    <div class="form-group">
      <input type="text" id="evTitle" placeholder="è¼¸å…¥äº‹é …åç¨±...">
    </div>
    <div class="form-group" style="display:flex; gap:10px; align-items:center;">
      <select id="evColor" style="width:100px;">
        <option value="#3b82f6">è—è‰² (ä¸€èˆ¬)</option>
        <option value="#10b981">ç¶ è‰² (å®Œæˆ)</option>
        <option value="#f59e0b">é»ƒè‰² (æ³¨æ„)</option>
        <option value="#64748b">ç°è‰² (å‚™è¨»)</option>
      </select>
      <label><input type="checkbox" id="evShow" checked> é¡¯ç¤ºåœ¨æœˆæ›†</label>
    </div>
    <button onclick="addNormalEvent()" style="width:100%;">æ–°å¢äº‹é …</button>
  </div>

  <div class="add-section" id="examAddSection" style="display:none; background:#fee2e2; border:1px solid #fca5a5;">
    <h4>â­ å»ºç«‹æ®µè€ƒæ’ç¨‹ (è‡ªå‹•æ¨ç®—)</h4>
    <div class="form-group">
      <label>ç›®æ¨™å¹´ç´š/ç­ç´š</label>
      <select id="examClass">
        <option value="14">ä¸€å››ç­</option>
        <option value="25">äºŒäº”ç­</option>
        <option value="36">ä¸‰å…­ç­</option>
      </select>
    </div>
    <div class="form-group">
      <label><input type="checkbox" id="examHoliday"> è€ƒå‰å…©é€±å…§é‡é€£å‡ (åŠ å¼·æ—¥å†æå‰ä¸€é€±)</label>
    </div>
    <button class="btn-exam" onclick="generateExamSchedule()" style="width:100%;">è‡ªå‹•ç”Ÿæˆè€ƒå‰åŠ å¼·èˆ‡å€’æ•¸</button>
  </div>
</div>

<script>
  let db = JSON.parse(localStorage.getItem('crm_events')) || [];
  let currentStartSunday = getSunday(new Date());
  let selectedDateStr = null;

  function getSunday(d) {
    let dt = new Date(d);
    dt.setDate(dt.getDate() - dt.getDay());
    return dt;
  }
  function formatDate(d) {
    return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;
  }

  function renderCalendar() {
    const grid = document.getElementById('daysGrid');
    grid.innerHTML = '';
    
    let endDate = new Date(currentStartSunday);
    endDate.setDate(endDate.getDate() + 27); // 4é€± = 28å¤©
    
    document.getElementById('viewRangeDisplay').innerText = 
      `${currentStartSunday.getMonth()+1}/${currentStartSunday.getDate()} - ${endDate.getMonth()+1}/${endDate.getDate()}`;

    for (let i = 0; i < 28; i++) {
      let d = new Date(currentStartSunday);
      d.setDate(d.getDate() + i);
      let dStr = formatDate(d);
      
      let cell = document.createElement('div');
      cell.className = `day-cell ${dStr === selectedDateStr ? 'active' : ''}`;
      cell.onclick = () => selectDate(dStr);
      
      let numDiv = document.createElement('div');
      numDiv.className = 'date-num';
      // å¦‚æœæ˜¯æ¯å€‹æœˆ1è™Ÿï¼Œé¡¯ç¤ºæœˆä»½
      numDiv.innerText = d.getDate() === 1 ? `${d.getMonth()+1}æœˆ1æ—¥` : d.getDate();
      cell.appendChild(numDiv);

      // æ¸²æŸ“æœ‰é–‹å•Ÿé¡¯ç¤ºçš„äº‹ä»¶
      let dayEvents = db.filter(e => e.date === dStr && e.show);
      dayEvents.forEach(e => {
        let badge = document.createElement('div');
        badge.className = 'event-badge';
        if(e.type === 'countdown') {
          badge.classList.add('event-countdown');
        } else {
          badge.style.backgroundColor = e.color;
        }
        badge.innerText = e.title;
        cell.appendChild(badge);
      });
      grid.appendChild(cell);
    }
  }

  function selectDate(dStr) {
    selectedDateStr = dStr;
    document.getElementById('panelTitle').innerText = `ğŸ“ ${dStr} äº‹é …æ¸…å–®`;
    document.getElementById('normalAddSection').style.display = 'block';
    document.getElementById('examAddSection').style.display = 'block';
    renderPanel();
    renderCalendar(); // åˆ·æ–°ä»¥é¡¯ç¤º active é‚Šæ¡†
  }

  function renderPanel() {
    const list = document.getElementById('eventList');
    list.innerHTML = '';
    if(!selectedDateStr) return;

    let dayEvents = db.filter(e => e.date === selectedDateStr);
    if(dayEvents.length === 0) {
      list.innerHTML = '<p style="color:#94a3b8; font-size:14px;">ç•¶æ—¥ç„¡äº‹é …</p>';
      return;
    }

    dayEvents.forEach(e => {
      let item = document.createElement('div');
      item.className = 'event-list-item';
      item.style.borderLeftColor = e.color;
      
      item.innerHTML = `
        <input type="checkbox" title="é¡¯ç¤ºåœ¨æœˆæ›†ä¸Š" ${e.show ? 'checked' : ''} onchange="toggleShow('${e.id}')">
        <div class="event-list-title" style="${e.type==='countdown'?'color:#ef4444;font-weight:bold;':''}">${e.title}</div>
        <button class="event-del-btn" onclick="deleteEvent('${e.id}')">åˆª</button>
      `;
      list.appendChild(item);
    });
  }

  function changeWeek(offset) {
    currentStartSunday.setDate(currentStartSunday.getDate() + (offset * 7));
    renderCalendar();
  }

  function addNormalEvent() {
    let title = document.getElementById('evTitle').value;
    if(!title) return alert('è«‹è¼¸å…¥äº‹é …åç¨±');
    
    db.push({
      id: Date.now().toString(),
      date: selectedDateStr,
      title: title,
      show: document.getElementById('evShow').checked,
      color: document.getElementById('evColor').value,
      type: 'normal'
    });
    
    document.getElementById('evTitle').value = '';
    saveAndRender();
  }

  function toggleShow(id) {
    let ev = db.find(e => e.id === id);
    if(ev) ev.show = !ev.show;
    saveAndRender();
  }

  function deleteEvent(id) {
    db = db.filter(e => e.id !== id);
    saveAndRender();
  }

  function saveAndRender() {
    localStorage.setItem('crm_events', JSON.stringify(db));
    renderPanel();
    renderCalendar();
  }

  // å¤§è…¦æ ¸å¿ƒï¼šæ®µè€ƒè‡ªå‹•åŒ–æ¨ç®—é‚è¼¯
  function generateExamSchedule() {
    if(!selectedDateStr) return;
    
    let classType = document.getElementById('examClass').value;
    let className = document.getElementById('examClass').options[document.getElementById('examClass').selectedIndex].text;
    let hasHoliday = document.getElementById('examHoliday').checked;
    
    let examDate = new Date(selectedDateStr);
    
    // 1. å»ºç«‹ç•¶å¤©çš„æ®µè€ƒæ¨™è¨˜
    db.push({
      id: Date.now().toString() + "_exam",
      date: selectedDateStr,
      title: `ğŸ† ${className} æ®µè€ƒæ—¥`,
      show: true, color: '#ef4444', type: 'exam'
    });

    // 2. æ¨ç®—è€ƒå‰åŠ å¼· (é€±å…­)
    // æ‰¾åˆ°æ®µè€ƒè©²é€±çš„æ˜ŸæœŸæ—¥
    let examSunday = getSunday(examDate);
    // é è¨­å€’é€€ 8 å¤©(å‰å…©é€±çš„é€±å…­)ï¼Œè‹¥é‡é€£å‡å€’é€€ 15 å¤©(å‰ä¸‰é€±çš„é€±å…­)
    let prepDaysBack = hasHoliday ? 15 : 8;
    let prepDate = new Date(examSunday);
    prepDate.setDate(prepDate.getDate() - prepDaysBack);
    
    db.push({
      id: Date.now().toString() + "_prep",
      date: formatDate(prepDate),
      title: `ğŸ›¡ï¸ ${className} è€ƒå‰åŠ å¼·`,
      show: true, color: '#8b5cf6', type: 'prep'
    });

    // 3. æ¨ç®—è€ƒå‰å…©é€±çš„å€’æ•¸å ‚æ•¸
    // è¨­å®šæ¨ç®—çš„èµ·é» (å‰å…©é€±çš„æ˜ŸæœŸæ—¥)
    let countdownStart = new Date(examSunday);
    countdownStart.setDate(countdownStart.getDate() - 14);
    
    let classDaysMatch = [];
    if(classType === '14') classDaysMatch = [1, 4]; // æ˜ŸæœŸä¸€ã€å››
    if(classType === '25') classDaysMatch = [2, 5]; // æ˜ŸæœŸäºŒã€äº”
    if(classType === '36') classDaysMatch = [3, 6]; // æ˜ŸæœŸä¸‰ã€å…­

    let classDates = [];
    // å¾èµ·é»é–‹å§‹ï¼Œä¸€å¤©ä¸€å¤©æª¢æŸ¥ï¼Œç›´åˆ°æ®µè€ƒå‰ä¸€å¤©
    for(let d = new Date(countdownStart); d < examDate; d.setDate(d.getDate() + 1)) {
      if(classDaysMatch.includes(d.getDay())) {
        classDates.push(formatDate(d));
      }
    }

    // ä¾åºæ¨™ä¸Šå€’æ•¸å ‚æ•¸
    let totalClasses = classDates.length;
    classDates.forEach((dStr, index) => {
      let count = totalClasses - index; // ä¾‹å¦‚å…±4å ‚ï¼Œç¬¬ä¸€ç­†å°±æ˜¯å€’æ•¸4
      db.push({
        id: Date.now().toString() + "_cnt_" + index,
        date: dStr,
        title: `ğŸ”¥ [${className}] å€’æ•¸ ${count} å ‚`,
        show: true, color: '#ffffff', type: 'countdown'
      });
    });

    alert(`å·²ç‚º ${className} å»ºç«‹æ®µè€ƒæ’ç¨‹ï¼\nåŠ å¼·èª²å®‰æ’æ–¼ï¼š${formatDate(prepDate)}\nå…±ç”Ÿæˆ ${totalClasses} å ‚å€’æ•¸è­¦ç¤ºã€‚`);
    saveAndRender();
  }

  // åˆå§‹åŒ–å•Ÿå‹•
  renderCalendar();
</script>

</body>
</html>
